{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../../services/presupuesto.service\";\nimport * as i2 from \"../../../services/tipo-gasto.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nfunction PresupuestoFormComponent_option_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 10);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const m_r1 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", m_r1.valor);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(m_r1.nombre);\n  }\n}\nfunction PresupuestoFormComponent_option_14_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 10);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const a_r2 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", a_r2);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(a_r2);\n  }\n}\nfunction PresupuestoFormComponent_div_20_tr_11_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"td\")(4, \"input\", 19);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function PresupuestoFormComponent_div_20_tr_11_Template_input_ngModelChange_4_listener($event) {\n      const presupuesto_r5 = i0.ɵɵrestoreView(_r4).$implicit;\n      i0.ɵɵtwoWayBindingSet(presupuesto_r5.montoPresupuestado, $event) || (presupuesto_r5.montoPresupuestado = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const presupuesto_r5 = ctx.$implicit;\n    const i_r6 = ctx.index;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(presupuesto_r5.tipoGastoDescripcion);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtwoWayProperty(\"ngModel\", presupuesto_r5.montoPresupuestado);\n    i0.ɵɵproperty(\"name\", \"monto\" + i_r6);\n  }\n}\nfunction PresupuestoFormComponent_div_20_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\")(1, \"h3\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"table\")(4, \"thead\")(5, \"tr\")(6, \"th\");\n    i0.ɵɵtext(7, \"Tipo de Gasto\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"th\");\n    i0.ɵɵtext(9, \"Monto Presupuestado\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(10, \"tbody\");\n    i0.ɵɵtemplate(11, PresupuestoFormComponent_div_20_tr_11_Template, 5, 3, \"tr\", 11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"tfoot\")(13, \"tr\")(14, \"td\")(15, \"strong\");\n    i0.ɵɵtext(16, \"Total Presupuestado:\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(17, \"td\")(18, \"strong\");\n    i0.ɵɵtext(19);\n    i0.ɵɵpipe(20, \"number\");\n    i0.ɵɵelementEnd()()()()();\n    i0.ɵɵelementStart(21, \"div\", 12)(22, \"button\", 13);\n    i0.ɵɵlistener(\"click\", function PresupuestoFormComponent_div_20_Template_button_click_22_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r6 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r6.guardarPresupuestos());\n    });\n    i0.ɵɵtext(23, \" \\uD83D\\uDCBE Guardar Presupuestos \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(24, \"button\", 14);\n    i0.ɵɵlistener(\"click\", function PresupuestoFormComponent_div_20_Template_button_click_24_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r6 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r6.resetearMontos());\n    });\n    i0.ɵɵtext(25, \" \\uD83D\\uDD04 Resetear a Cero \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(26, \"button\", 15);\n    i0.ɵɵlistener(\"click\", function PresupuestoFormComponent_div_20_Template_button_click_26_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r6 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r6.eliminarPresupuestosMes());\n    });\n    i0.ɵɵtext(27, \" \\uD83D\\uDDD1\\uFE0F Eliminar Mes Completo \");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(28, \"div\", 16)(29, \"strong\");\n    i0.ɵɵtext(30, \"Nota:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(31, \" Solo se guardar\\u00E1n los presupuestos con montos mayores a cero. Los presupuestos existentes se actualizar\\u00E1n, los nuevos se crear\\u00E1n. \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(32, \"div\", 17)(33, \"strong\");\n    i0.ɵɵtext(34, \"Funciones adicionales:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(35, \"ul\", 18)(36, \"li\")(37, \"strong\");\n    i0.ɵɵtext(38, \"Resetear a Cero:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(39, \" Pone todos los montos en $0 (debe hacer clic en \\\"Guardar\\\" despu\\u00E9s)\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(40, \"li\")(41, \"strong\");\n    i0.ɵɵtext(42, \"Eliminar Mes Completo:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(43, \" Elimina permanentemente TODOS los presupuestos del mes seleccionado\");\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r6 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\"Presupuesto para \", ctx_r6.getNombreMes(), \" \", ctx_r6.anio, \"\");\n    i0.ɵɵadvance(9);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r6.presupuestos);\n    i0.ɵɵadvance(8);\n    i0.ɵɵtextInterpolate1(\"$\", i0.ɵɵpipeBind2(20, 4, ctx_r6.calcularTotal(), \"1.2-2\"), \"\");\n  }\n}\nfunction PresupuestoFormComponent_div_21_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 20)(1, \"p\");\n    i0.ɵɵtext(2, \"Seleccione un mes y a\\u00F1o, luego haga clic en \\\"Cargar Presupuestos\\\"\");\n    i0.ɵɵelementEnd()();\n  }\n}\nexport let PresupuestoFormComponent = /*#__PURE__*/(() => {\n  class PresupuestoFormComponent {\n    constructor(presupuestoService, tipoGastoService) {\n      this.presupuestoService = presupuestoService;\n      this.tipoGastoService = tipoGastoService;\n      this.mes = new Date().getMonth() + 1;\n      this.anio = new Date().getFullYear();\n      this.presupuestos = [];\n      this.tiposGasto = [];\n      this.loaded = false;\n      this.meses = [{\n        valor: 1,\n        nombre: 'Enero'\n      }, {\n        valor: 2,\n        nombre: 'Febrero'\n      }, {\n        valor: 3,\n        nombre: 'Marzo'\n      }, {\n        valor: 4,\n        nombre: 'Abril'\n      }, {\n        valor: 5,\n        nombre: 'Mayo'\n      }, {\n        valor: 6,\n        nombre: 'Junio'\n      }, {\n        valor: 7,\n        nombre: 'Julio'\n      }, {\n        valor: 8,\n        nombre: 'Agosto'\n      }, {\n        valor: 9,\n        nombre: 'Septiembre'\n      }, {\n        valor: 10,\n        nombre: 'Octubre'\n      }, {\n        valor: 11,\n        nombre: 'Noviembre'\n      }, {\n        valor: 12,\n        nombre: 'Diciembre'\n      }];\n      this.anios = [];\n      const currentYear = new Date().getFullYear();\n      for (let i = currentYear - 2; i <= currentYear + 2; i++) {\n        this.anios.push(i);\n      }\n    }\n    ngOnInit() {\n      this.loadTiposGasto();\n    }\n    loadTiposGasto() {\n      this.tipoGastoService.getAll().subscribe({\n        next: data => {\n          this.tiposGasto = data;\n        },\n        error: error => {\n          console.error('Error al cargar tipos de gasto:', error);\n          alert('Error al cargar tipos de gasto');\n        }\n      });\n    }\n    cargarPresupuestos() {\n      this.presupuestoService.getPresupuestosPorMes(this.mes, this.anio).subscribe({\n        next: data => {\n          this.presupuestos = data.items;\n          this.loaded = true;\n          if (this.presupuestos.length === 0) {\n            // Caso 1: No hay presupuestos para este mes, inicializar todos\n            this.inicializarPresupuestos();\n          } else {\n            // Caso 2: Ya hay presupuestos, pero verificar si hay nuevos tipos de gasto\n            this.agregarTiposGastoFaltantes();\n          }\n        },\n        error: error => {\n          console.error('Error al cargar presupuestos:', error);\n          alert('Error al cargar presupuestos');\n        }\n      });\n    }\n    agregarTiposGastoFaltantes() {\n      // Obtener IDs de tipos de gasto que ya tienen presupuesto\n      const tiposConPresupuesto = this.presupuestos.map(p => p.tipoGastoId);\n      // Encontrar tipos de gasto que NO tienen presupuesto en este mes\n      const tiposFaltantes = this.tiposGasto.filter(tipo => !tiposConPresupuesto.includes(tipo.tipoGastoId));\n      // Agregar los tipos de gasto faltantes con monto 0\n      tiposFaltantes.forEach(tipo => {\n        this.presupuestos.push({\n          presupuestoId: 0,\n          tipoGastoId: tipo.tipoGastoId,\n          tipoGastoDescripcion: tipo.descripcion,\n          montoPresupuestado: 0\n        });\n      });\n      // Ordenar por descripción para mantener consistencia\n      this.presupuestos.sort((a, b) => a.tipoGastoDescripcion.localeCompare(b.tipoGastoDescripcion));\n    }\n    inicializarPresupuestos() {\n      this.presupuestos = this.tiposGasto.map(tipo => ({\n        presupuestoId: 0,\n        tipoGastoId: tipo.tipoGastoId,\n        tipoGastoDescripcion: tipo.descripcion,\n        montoPresupuestado: 0\n      }));\n    }\n    guardarPresupuestos() {\n      if (!this.loaded) {\n        alert('Primero debe cargar los presupuestos');\n        return;\n      }\n      let errores = 0;\n      let creados = 0;\n      let actualizados = 0;\n      const total = this.presupuestos.filter(p => p.montoPresupuestado > 0).length;\n      let procesados = 0;\n      this.presupuestos.forEach(presupuesto => {\n        if (presupuesto.montoPresupuestado <= 0) {\n          return;\n        }\n        if (presupuesto.presupuestoId === 0) {\n          const crear = {\n            tipoGastoId: presupuesto.tipoGastoId,\n            mes: this.mes,\n            anio: this.anio,\n            montoPresupuestado: presupuesto.montoPresupuestado\n          };\n          this.presupuestoService.create(crear).subscribe({\n            next: () => {\n              creados++;\n              procesados++;\n              if (procesados === total) {\n                this.mostrarResultado(creados, actualizados, errores);\n              }\n            },\n            error: error => {\n              errores++;\n              procesados++;\n              console.error('Error al crear:', error);\n              if (procesados === total) {\n                this.mostrarResultado(creados, actualizados, errores);\n              }\n            }\n          });\n        } else {\n          const actualizar = {\n            montoPresupuestado: presupuesto.montoPresupuestado\n          };\n          this.presupuestoService.update(presupuesto.presupuestoId, actualizar).subscribe({\n            next: () => {\n              actualizados++;\n              procesados++;\n              if (procesados === total) {\n                this.mostrarResultado(creados, actualizados, errores);\n              }\n            },\n            error: error => {\n              errores++;\n              procesados++;\n              console.error('Error al actualizar:', error);\n              if (procesados === total) {\n                this.mostrarResultado(creados, actualizados, errores);\n              }\n            }\n          });\n        }\n      });\n      if (total === 0) {\n        alert('No hay presupuestos con montos mayores a cero para guardar');\n      }\n    }\n    mostrarResultado(creados, actualizados, errores) {\n      let mensaje = 'Presupuestos guardados:\\n\\n';\n      if (creados > 0) mensaje += `Creados: ${creados}\\n`;\n      if (actualizados > 0) mensaje += `Actualizados: ${actualizados}\\n`;\n      if (errores > 0) mensaje += `Errores: ${errores}\\n`;\n      alert(mensaje);\n      this.cargarPresupuestos();\n    }\n    calcularTotal() {\n      return this.presupuestos.reduce((sum, p) => sum + (p.montoPresupuestado || 0), 0);\n    }\n    getNombreMes() {\n      const mesObj = this.meses.find(m => m.valor === this.mes);\n      return mesObj ? mesObj.nombre : '';\n    }\n    resetearMontos() {\n      if (!this.loaded) {\n        alert('Primero debe cargar los presupuestos');\n        return;\n      }\n      const confirmacion = confirm(`¿Está seguro que desea poner en cero TODOS los montos de ${this.getNombreMes()} ${this.anio}?\\n\\nNota: Esto solo resetea los valores en pantalla. Use \"Guardar\" para aplicar los cambios.`);\n      if (confirmacion) {\n        this.presupuestos.forEach(p => p.montoPresupuestado = 0);\n        alert('Montos reseteados a cero. Recuerde hacer clic en \"Guardar\" para aplicar los cambios.');\n      }\n    }\n    eliminarPresupuestosMes() {\n      if (!this.loaded) {\n        alert('Primero debe cargar los presupuestos');\n        return;\n      }\n      const presupuestosExistentes = this.presupuestos.filter(p => p.presupuestoId > 0);\n      if (presupuestosExistentes.length === 0) {\n        alert('No hay presupuestos guardados en este mes para eliminar.');\n        return;\n      }\n      const nombreMes = this.getNombreMes();\n      const mesAnio = nombreMes ? `${nombreMes} ${this.anio}` : `Mes ${this.mes}/${this.anio}`;\n      const confirmacion = confirm(`¿Está seguro que desea ELIMINAR PERMANENTEMENTE todos los presupuestos de ${mesAnio}?\\n\\n` + `Se eliminarán ${presupuestosExistentes.length} presupuesto(s) SOLO de este mes.\\n\\n` + `Esta acción NO se puede deshacer.`);\n      if (!confirmacion) {\n        return;\n      }\n      let eliminados = 0;\n      let errores = 0;\n      const total = presupuestosExistentes.length;\n      presupuestosExistentes.forEach(presupuesto => {\n        this.presupuestoService.delete(presupuesto.presupuestoId).subscribe({\n          next: () => {\n            eliminados++;\n            if (eliminados + errores === total) {\n              this.mostrarResultadoEliminacion(eliminados, errores);\n            }\n          },\n          error: error => {\n            errores++;\n            console.error('Error al eliminar:', error);\n            if (eliminados + errores === total) {\n              this.mostrarResultadoEliminacion(eliminados, errores);\n            }\n          }\n        });\n      });\n    }\n    mostrarResultadoEliminacion(eliminados, errores) {\n      let mensaje = 'Resultado de la eliminación:\\n\\n';\n      if (eliminados > 0) mensaje += `✓ Eliminados: ${eliminados}\\n`;\n      if (errores > 0) mensaje += `✗ Errores: ${errores}\\n`;\n      alert(mensaje);\n      this.cargarPresupuestos(); // Recargar para mostrar el mes vacío\n    }\n    static {\n      this.ɵfac = function PresupuestoFormComponent_Factory(t) {\n        return new (t || PresupuestoFormComponent)(i0.ɵɵdirectiveInject(i1.PresupuestoService), i0.ɵɵdirectiveInject(i2.TipoGastoService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: PresupuestoFormComponent,\n        selectors: [[\"app-presupuesto-form\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 22,\n        vars: 6,\n        consts: [[1, \"card\"], [1, \"filters\", \"mb-3\"], [1, \"form-row\"], [1, \"form-group\"], [\"name\", \"mes\", 1, \"form-control\", 3, \"ngModelChange\", \"ngModel\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [\"name\", \"anio\", 1, \"form-control\", 3, \"ngModelChange\", \"ngModel\"], [1, \"btn\", \"btn-primary\", 3, \"click\"], [4, \"ngIf\"], [\"class\", \"text-center mt-3\", 4, \"ngIf\"], [3, \"value\"], [4, \"ngFor\", \"ngForOf\"], [1, \"mt-3\"], [1, \"btn\", \"btn-success\", 3, \"click\"], [1, \"btn\", \"btn-warning\", 2, \"margin-left\", \"10px\", 3, \"click\"], [1, \"btn\", \"btn-danger\", 2, \"margin-left\", \"10px\", 3, \"click\"], [1, \"alert\", \"alert-info\", \"mt-3\"], [1, \"alert\", \"alert-warning\", \"mt-2\"], [2, \"margin-bottom\", \"0\"], [\"type\", \"number\", \"min\", \"0\", \"step\", \"0.01\", \"placeholder\", \"0.00\", 1, \"form-control\", 3, \"ngModelChange\", \"ngModel\", \"name\"], [1, \"text-center\", \"mt-3\"]],\n        template: function PresupuestoFormComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 0)(1, \"h2\");\n            i0.ɵɵtext(2, \"Presupuesto Mensual por Tipo de Gasto\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"div\", 1)(4, \"div\", 2)(5, \"div\", 3)(6, \"label\");\n            i0.ɵɵtext(7, \"Mes:\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(8, \"select\", 4);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function PresupuestoFormComponent_Template_select_ngModelChange_8_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.mes, $event) || (ctx.mes = $event);\n              return $event;\n            });\n            i0.ɵɵtemplate(9, PresupuestoFormComponent_option_9_Template, 2, 2, \"option\", 5);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(10, \"div\", 3)(11, \"label\");\n            i0.ɵɵtext(12, \"A\\u00F1o:\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(13, \"select\", 6);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function PresupuestoFormComponent_Template_select_ngModelChange_13_listener($event) {\n              i0.ɵɵtwoWayBindingSet(ctx.anio, $event) || (ctx.anio = $event);\n              return $event;\n            });\n            i0.ɵɵtemplate(14, PresupuestoFormComponent_option_14_Template, 2, 2, \"option\", 5);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(15, \"div\", 3)(16, \"label\");\n            i0.ɵɵtext(17, \"\\u00A0\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(18, \"button\", 7);\n            i0.ɵɵlistener(\"click\", function PresupuestoFormComponent_Template_button_click_18_listener() {\n              return ctx.cargarPresupuestos();\n            });\n            i0.ɵɵtext(19, \" Cargar Presupuestos \");\n            i0.ɵɵelementEnd()()()();\n            i0.ɵɵtemplate(20, PresupuestoFormComponent_div_20_Template, 44, 7, \"div\", 8)(21, PresupuestoFormComponent_div_21_Template, 3, 0, \"div\", 9);\n            i0.ɵɵelementEnd();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(8);\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.mes);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngForOf\", ctx.meses);\n            i0.ɵɵadvance(4);\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.anio);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngForOf\", ctx.anios);\n            i0.ɵɵadvance(6);\n            i0.ɵɵproperty(\"ngIf\", ctx.loaded);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.loaded);\n          }\n        },\n        dependencies: [CommonModule, i3.NgForOf, i3.NgIf, i3.DecimalPipe, FormsModule, i4.NgSelectOption, i4.ɵNgSelectMultipleOption, i4.DefaultValueAccessor, i4.NumberValueAccessor, i4.SelectControlValueAccessor, i4.NgControlStatus, i4.MinValidator, i4.NgModel],\n        styles: [\"h2[_ngcontent-%COMP%], h3[_ngcontent-%COMP%]{color:#2c3e50;margin-bottom:20px}.filters[_ngcontent-%COMP%]{background-color:#f8f9fa;padding:15px;border-radius:8px}.form-row[_ngcontent-%COMP%]{display:flex;gap:15px;align-items:flex-end}.form-group[_ngcontent-%COMP%]{flex:1}table[_ngcontent-%COMP%]{width:100%;margin-top:20px}table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   input.form-control[_ngcontent-%COMP%]{max-width:200px}tfoot[_ngcontent-%COMP%]{font-size:16px;background-color:#f8f9fa}\"]\n      });\n    }\n  }\n  return PresupuestoFormComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}